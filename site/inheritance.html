<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8" />
<title>Inheritance &middot; Crafting Interpreters</title>

<!-- Tell mobile browsers we're optimized for them and they don't need to crop
     the viewport. -->
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="stylesheet" type="text/css" href="style.css" />

<!-- Oh, God, Source Code Pro is so beautiful it makes me want to cry. -->
<link href='http://fonts.googleapis.com/css?family=Source+Code+Pro:400|Source+Sans+Pro:300,400,600' rel='stylesheet' type='text/css'>
<link rel="icon" type="image/png" href="image/favicon.png" />
<script src="jquery-1.10.1.min.js"></script>
<script src="script.js"></script>

<!-- Google analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-42804721-2', 'auto');
  ga('send', 'pageview');
</script>

</head>
<body id="top">

<!-- <div class="scrim"></div> -->
<nav class="wide">
  <a href="/"><img src="image/logotype-small.png" title="Crafting Interpreters"></a>
  <div class="contents">
<!-- If there is a part, it must be a chapter within a part. -->
<h3><a href="#top">Inheritance<small>13</small></a></h3>

<ul>
    <li><a href="#superclasses-and-subclasses"><small>13.1</small> superclasses and subclasses</a></li>
    <li><a href="#inheriting-methods"><small>13.2</small> inheriting methods</a></li>
    <li><a href="#super"><small>13.3</small> super</a></li>
    <li><a href="#conclusion"><small>13.4</small> Conclusion</a></li>
    <li class="divider"></li>
    <li class="end-part"><a href="#challenges">Challenges</a></li>
</ul>


<div class="prev-next">
    <a href="classes.html" title="Classes" class="left">&larr;&nbsp;Previous</a>
    <a href="a-tree-walk-interpreter.html" title="A Tree-Walk Interpreter">&uarr;&nbsp;Up</a>
    <a href="a-bytecode-virtual-machine.html" title="A Bytecode Virtual Machine" class="right">Next&nbsp;&rarr;</a>
</div>  </div>
</nav>

<nav class="narrow">
<a href="/"><img src="image/logotype-small.png" title="Crafting Interpreters"></a>
<a href="classes.html" title="Classes" class="prev">←</a>
<a href="a-bytecode-virtual-machine.html" title="A Bytecode Virtual Machine" class="next">→</a>
</nav>

<div class="page">
<div class="nav-wrapper">
<nav class="floating">
  <a href="/"><img src="image/logotype-small.png" title="Crafting Interpreters"></a>
  <div class="expandable">
<!-- If there is a part, it must be a chapter within a part. -->
<h3><a href="#top">Inheritance<small>13</small></a></h3>

<ul>
    <li><a href="#superclasses-and-subclasses"><small>13.1</small> superclasses and subclasses</a></li>
    <li><a href="#inheriting-methods"><small>13.2</small> inheriting methods</a></li>
    <li><a href="#super"><small>13.3</small> super</a></li>
    <li><a href="#conclusion"><small>13.4</small> Conclusion</a></li>
    <li class="divider"></li>
    <li class="end-part"><a href="#challenges">Challenges</a></li>
</ul>


<div class="prev-next">
    <a href="classes.html" title="Classes" class="left">&larr;&nbsp;Previous</a>
    <a href="a-tree-walk-interpreter.html" title="A Tree-Walk Interpreter">&uarr;&nbsp;Up</a>
    <a href="a-bytecode-virtual-machine.html" title="A Bytecode Virtual Machine" class="right">Next&nbsp;&rarr;</a>
</div>  </div>
  <a id="expand-nav">≡</a>
</nav>
</div>

<article class="chapter">

  <div class="number">13</div>
  <h1>Inheritance</h1>

<div class="sign-up closable">
    <h1>This book is a work in progress!</h1>
    <span class="dismiss">&times;</span>
    <p>If you see a mistake, find something unclear, or have a suggestion, please <a href="https://github.com/munificent/craftinginterpreters/issues" target="_blank">let me know</a>. To learn when new chapters are up, join the mailing list:</p>

  <!-- Begin MailChimp Signup Form -->
  <div id="mc_embed_signup">
  <form action="//gameprogrammingpatterns.us7.list-manage.com/subscribe/post?u=0952ca43ed2536d6717766b88&amp;id=6e96334109" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="Your email address" required>
    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
    <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_0952ca43ed2536d6717766b88_6e96334109" tabindex="-1" value=""></div>
    <input type="submit" value="Sign me up!" name="subscribe" id="mc-embedded-subscribe" class="button">
  </form>
  </div>
  <!--End mc_embed_signup-->
  <p class="small">(I post about once a month. Don&#8217;t worry, I won&#8217;t spam you.)</p>
</div>

<ul>
<li>last chapter, almost done with java interp</li>
<li>had to put lot in last chapter because all tied together</li>
<li>
<p>one separable part, inheritance</p>
</li>
<li>
<p>classes reuse behavior across instances</p>
</li>
<li>inheritance shares behavior across classes</li>
<li>reflects commonality between classes</li>
<li>in static type lang, establishes subtype rel</li>
<li>
<p>[not priv inheritance in c++]</p>
</li>
<li>
<p>used to be major part of oop langs and oop style</p>
</li>
<li>today, less used</li>
<li>
<p>powerful tool, dangerous</p>
</li>
<li>
<p>part of every oop lang back to simula</p>
</li>
<li>want for lox too</li>
</ul>
<h2><a href="#superclasses-and-subclasses" name="superclasses-and-subclasses"><small>13&#8202;.&#8202;1</small> superclasses and subclasses</a></h2>
<ul>
<li>what is inheritance?</li>
<li>relationship between classes</li>
<li>class inherits from another</li>
<li>lot of terms</li>
<li>base and derived</li>
<li>class inherited from called superclass, inheriting class subclass</li>
<li>history murky</li>
<li>simula got &ldquo;subclass&rdquo; for c.a.r. hoare&rsquo;s record handling paper</li>
<li>used &ldquo;prefix class&rdquo; for superclass</li>
<li>
<p>not sure who started using super, maybe smalltalk</p>
</li>
<li>
<p>need way to declare superclass</p>
</li>
<li>langs have very different syntax</li>
<li>python put super in parans</li>
<li>c++/c# uses colon</li>
<li>java, php &ldquo;extends&rdquo;</li>
<li>simula put superclass before sub</li>
<li>don&rsquo;t want to add keyword like &ldquo;extends&rdquo;, don&rsquo;t have colon in grammar</li>
<li>take ruby and use &ldquo;&lt;&rdquo;</li>
<li>
<p>[kinda weird, aligns with subtyping</p>
<ul>
<li>set of all objects of super larger than set of all objs of sub]</li>
</ul>
</li>
<li>
<p>replace rule</p>
</li>
</ul>
<div class="codehilite"><pre><span></span><span class="n">classDecl</span> <span class="err">→</span> <span class="s">&quot;class&quot;</span> <span class="vg">IDENTIFIER</span> <span class="p">(</span> <span class="s">&quot;&lt;&quot;</span> <span class="vg">IDENTIFIER</span> <span class="p">)</span><span class="err">?</span>
            <span class="s">&quot;{&quot;</span> <span class="n">function</span><span class="o">*</span> <span class="s">&quot;}&quot;</span> <span class="p">;</span>
</pre></div>


<ul>
<li>superclass optional</li>
<li>can not have superclass</li>
<li>no root obj class in lox, so no super means class is has no super at all</li>
</ul>
<div class="codehilite"><pre class="insert-before"><span></span>      <span class="s">&quot;Block      : List&lt;Stmt&gt; statements&quot;</span><span class="o">,</span>
</pre><div class="source-file"><em>tool/GenerateAst.java</em><br>
in <em>main</em>()<br>
replace 1 line</div>
<pre class="insert"><span></span>      <span class="s">&quot;Class      : Token name, Expr superclass,&quot;</span> <span class="o">+</span>
                  <span class="s">&quot; List&lt;Stmt.Function&gt; methods&quot;</span><span class="o">,</span>
</pre><pre class="insert-after"><span></span>      <span class="s">&quot;Expression : Expr expression&quot;</span><span class="o">,</span>
</pre></div>

<ul>
<li>super class is expr</li>
<li>grammatically always ident</li>
<li>eval at runtime by looking up var</li>
</ul>
<div class="codehilite"><pre class="insert-before"><span></span>    <span class="n">Token</span> <span class="n">name</span> <span class="o">=</span> <span class="n">consume</span><span class="o">(</span><span class="n">IDENTIFIER</span><span class="o">,</span> <span class="s">&quot;Expect class name.&quot;</span><span class="o">);</span>
</pre><div class="source-file"><em>lox/Parser.java</em><br>
in <em>classDeclaration</em>()</div>
<pre class="insert"><br><span></span>    <span class="n">Expr</span> <span class="n">superclass</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">match</span><span class="o">(</span><span class="n">LESS</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">consume</span><span class="o">(</span><span class="n">IDENTIFIER</span><span class="o">,</span> <span class="s">&quot;Expect superclass name.&quot;</span><span class="o">);</span>
      <span class="n">superclass</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Expr</span><span class="o">.</span><span class="na">Variable</span><span class="o">(</span><span class="n">previous</span><span class="o">());</span>
    <span class="o">}</span>
<br></pre><pre class="insert-after"><span></span>    <span class="n">consume</span><span class="o">(</span><span class="n">LEFT_BRACE</span><span class="o">,</span> <span class="s">&quot;Expect &#39;{&#39; before class body.&quot;</span><span class="o">);</span>
</pre></div>

<ul>
<li>matches grammar</li>
</ul>
<div class="codehilite"><pre class="insert-before"><span></span>    <span class="n">consume</span><span class="o">(</span><span class="n">RIGHT_BRACE</span><span class="o">,</span> <span class="s">&quot;Expect &#39;}&#39; after class body.&quot;</span><span class="o">);</span>
<br></pre><div class="source-file"><em>lox/Parser.java</em><br>
in <em>classDeclaration</em>()<br>
replace 1 line</div>
<pre class="insert"><span></span>    <span class="k">return</span> <span class="k">new</span> <span class="n">Stmt</span><span class="o">.</span><span class="na">Class</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">superclass</span><span class="o">,</span> <span class="n">methods</span><span class="o">);</span>
</pre><pre class="insert-after"><span></span>  <span class="o">}</span>
</pre></div>

<ul>
<li>store in ast</li>
<li>
<p>null if no super</p>
</li>
<li>
<p>class ast has new subexpr, need to resolve</p>
</li>
</ul>
<div class="codehilite"><pre class="insert-before"><span></span>    <span class="n">currentClass</span> <span class="o">=</span> <span class="n">ClassType</span><span class="o">.</span><span class="na">CLASS</span><span class="o">;</span>
</pre><div class="source-file"><em>lox/Resolver.java</em><br>
in <em>visitClassStmt</em>()</div>
<pre class="insert"><br><span></span>    <span class="k">if</span> <span class="o">(</span><span class="n">stmt</span><span class="o">.</span><span class="na">superclass</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">resolve</span><span class="o">(</span><span class="n">stmt</span><span class="o">.</span><span class="na">superclass</span><span class="o">);</span>
    <span class="o">}</span>
</pre><pre class="insert-after"><br><span></span>    <span class="n">beginScope</span><span class="o">();</span>
</pre></div>

<ul>
<li>
<p>usually global var, but could be nested local var</p>
</li>
<li>
<p>push through runtime</p>
</li>
<li>eval superclass expr if have one</li>
</ul>
<div class="codehilite"><pre class="insert-before"><span></span>    <span class="n">environment</span><span class="o">.</span><span class="na">define</span><span class="o">(</span><span class="n">stmt</span><span class="o">.</span><span class="na">name</span><span class="o">.</span><span class="na">lexeme</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</pre><div class="source-file"><em>lox/Interpreter.java</em><br>
in <em>visitClassStmt</em>()</div>
<pre class="insert"><span></span>    <span class="n">Object</span> <span class="n">superclass</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">stmt</span><span class="o">.</span><span class="na">superclass</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">superclass</span> <span class="o">=</span> <span class="n">evaluate</span><span class="o">(</span><span class="n">stmt</span><span class="o">.</span><span class="na">superclass</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(!(</span><span class="n">superclass</span> <span class="k">instanceof</span> <span class="n">LoxClass</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeError</span><span class="o">(</span><span class="n">stmt</span><span class="o">.</span><span class="na">name</span><span class="o">,</span>
            <span class="s">&quot;Superclass must be a class.&quot;</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">}</span>
<br></pre><pre class="insert-after"><span></span>    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">LoxFunction</span><span class="o">&gt;</span> <span class="n">methods</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
</pre></div>

<ul>
<li>no static checking, so need to check at runtime that got class</li>
<li>
<p>can&rsquo;t inherit from a number</p>
</li>
<li>
<p>store in runtime rep too</p>
</li>
</ul>
<div class="codehilite"><pre class="insert-before"><span></span>      <span class="n">methods</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">name</span><span class="o">.</span><span class="na">lexeme</span><span class="o">,</span> <span class="n">function</span><span class="o">);</span>
    <span class="o">}</span>
<br></pre><div class="source-file"><em>lox/Interpreter.java</em><br>
in <em>visitClassStmt</em>()<br>
replace 1 line</div>
<pre class="insert"><span></span>    <span class="n">LoxClass</span> <span class="n">klass</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LoxClass</span><span class="o">(</span><span class="n">stmt</span><span class="o">.</span><span class="na">name</span><span class="o">.</span><span class="na">lexeme</span><span class="o">,</span>
        <span class="o">(</span><span class="n">LoxClass</span><span class="o">)</span><span class="n">superclass</span><span class="o">,</span> <span class="n">methods</span><span class="o">);</span>
<br></pre><pre class="insert-after"><span></span>    <span class="n">environment</span><span class="o">.</span><span class="na">assign</span><span class="o">(</span><span class="n">stmt</span><span class="o">.</span><span class="na">name</span><span class="o">,</span> <span class="n">klass</span><span class="o">);</span>
</pre></div>

<ul>
<li>need new field</li>
</ul>
<div class="codehilite"><pre class="insert-before"><span></span>  <span class="kd">final</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
</pre><div class="source-file"><em>lox/LoxClass.java</em><br>
in class <em>LoxClass</em></div>
<pre class="insert"><span></span>  <span class="kd">final</span> <span class="n">LoxClass</span> <span class="n">superclass</span><span class="o">;</span>
</pre><pre class="insert-after"><span></span>  <span class="kd">private</span> <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">LoxFunction</span><span class="o">&gt;</span> <span class="n">methods</span><span class="o">;</span>
</pre></div>

<ul>
<li>init in ctor</li>
</ul>
<div class="codehilite"><div class="source-file"><em>lox/LoxClass.java</em><br>
method <em>LoxClass</em>()<br>
replace 1 line</div>
<pre class="insert"><span></span>  <span class="n">LoxClass</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">LoxClass</span> <span class="n">superclass</span><span class="o">,</span>
           <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">LoxFunction</span><span class="o">&gt;</span> <span class="n">methods</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">superclass</span> <span class="o">=</span> <span class="n">superclass</span><span class="o">;</span>
</pre><pre class="insert-after"><span></span>    <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
</pre></div>

<ul>
<li>ok, have superclass now</li>
</ul>
<h2><a href="#inheriting-methods" name="inheriting-methods"><small>13&#8202;.&#8202;2</small> inheriting methods</a></h2>
<ul>
<li>have superclass</li>
<li>what does it do?</li>
<li>if method isn&rsquo;t found on class, look for it in superclass</li>
<li>in lang with static type, also establish subtype rel, storage around fields,</li>
<li>
<p>for lox, just methods</p>
</li>
<li>
<p>easy to impl</p>
</li>
</ul>
<div class="codehilite"><pre class="insert-before"><span></span>      <span class="k">return</span> <span class="n">methods</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">name</span><span class="o">).</span><span class="na">bind</span><span class="o">(</span><span class="n">instance</span><span class="o">);</span>
    <span class="o">}</span>
<br></pre><div class="source-file"><em>lox/LoxClass.java</em><br>
in <em>findMethod</em>()</div>
<pre class="insert"><span></span>    <span class="k">if</span> <span class="o">(</span><span class="n">superclass</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">superclass</span><span class="o">.</span><span class="na">findMethod</span><span class="o">(</span><span class="n">instance</span><span class="o">,</span> <span class="n">name</span><span class="o">);</span>
    <span class="o">}</span>
<br></pre><pre class="insert-after"><span></span>    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</pre></div>

<ul>
<li>literally it</li>
</ul>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="vg">Doughnut</span> <span class="p">{</span>
  <span class="n">cook</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">print</span> <span class="s">&quot;Fry until golden brown.&quot;</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">class</span> <span class="vg">BostonCream</span> <span class="o">&lt;</span> <span class="vg">Doughnut</span> <span class="p">{}</span>

<span class="vg">BostonCream</span><span class="p">().</span><span class="n">cook</span><span class="p">();</span>
</pre></div>


<h2><a href="#super" name="super"><small>13&#8202;.&#8202;3</small> super</a></h2>
<ul>
<li>earlier said if method isn&rsquo;t found on class, look for it in superclass</li>
<li>&ldquo;if&rdquo; brings up important point</li>
<li>if method found on subclass, does not look in superclass</li>
<li>could be in both</li>
<li>subclass overrides superclass</li>
<li>
<p>[aside about beta inner]</p>
</li>
<li>
<p>like shadowing var, means superclass method hidden</p>
</li>
<li>other want subclass method that refines but does not replace super</li>
<li>need access to superclass one</li>
<li>super expr</li>
</ul>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="vg">Doughnut</span> <span class="p">{</span>
  <span class="n">cook</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">print</span> <span class="s">&quot;Fry until golden brown.&quot;</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">class</span> <span class="vg">BostonCream</span> <span class="o">&lt;</span> <span class="vg">Doughnut</span> <span class="p">{</span>
  <span class="n">cook</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">.</span><span class="n">cook</span><span class="p">();</span>
    <span class="k">print</span> <span class="s">&quot;Pipe full of custard and coat with chocolate.&quot;</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="vg">BostonCream</span><span class="p">().</span><span class="n">cook</span><span class="p">();</span>
</pre></div>


<ul>
<li>super followed by dotted method call looks up method with name but starts
  search at superclass</li>
</ul>
<h3><a href="#syntax" name="syntax"><small>13&#8202;.&#8202;3&#8202;.&#8202;1</small> syntax</a></h3>
<ul>
<li>seems like <code>this</code> in that sort of like magic var based on surrounding context</li>
<li>not identifier but prefix of prop access</li>
</ul>
<div class="codehilite"><pre><span></span><span class="n">primary</span> <span class="err">→</span> <span class="s">&quot;true&quot;</span> <span class="err">|</span> <span class="s">&quot;false&quot;</span> <span class="err">|</span> <span class="s">&quot;null&quot;</span> <span class="err">|</span> <span class="s">&quot;this&quot;</span>
        <span class="err">|</span> <span class="vg">NUMBER</span> <span class="err">|</span> <span class="vg">STRING</span> <span class="err">|</span> <span class="vg">IDENTIFIER</span> <span class="err">|</span> <span class="s">&quot;(&quot;</span> <span class="n">expression</span> <span class="s">&quot;)&quot;</span>
        <span class="err">|</span> <span class="s">&quot;super&quot;</span> <span class="s">&quot;.&quot;</span> <span class="vg">IDENTIFIER</span> <span class="p">;</span>
</pre></div>


<ul>
<li>no bare &ldquo;super&rdquo;, need dot and name after</li>
<li>don&rsquo;t need arg list&#8202;&mdash;&#8202;can get handle to super method then invoke later</li>
</ul>
<div class="codehilite"><pre class="insert-before"><span></span>      <span class="s">&quot;Set      : Expr object, Token name, Expr value&quot;</span><span class="o">,</span>
</pre><div class="source-file"><em>tool/GenerateAst.java</em><br>
in <em>main</em>()</div>
<pre class="insert"><span></span>      <span class="s">&quot;Super    : Token keyword, Token method&quot;</span><span class="o">,</span>
</pre><pre class="insert-after"><span></span>      <span class="s">&quot;This     : Token keyword&quot;</span><span class="o">,</span>
</pre></div>

<ul>
<li>expr store keyword (for errors) and name of prop</li>
</ul>
<div class="codehilite"><pre class="insert-before"><span></span>      <span class="k">return</span> <span class="k">new</span> <span class="n">Expr</span><span class="o">.</span><span class="na">Literal</span><span class="o">(</span><span class="n">previous</span><span class="o">().</span><span class="na">literal</span><span class="o">);</span>
    <span class="o">}</span>
</pre><div class="source-file"><em>lox/Parser.java</em><br>
in <em>primary</em>()</div>
<pre class="insert"><br><span></span>    <span class="k">if</span> <span class="o">(</span><span class="n">match</span><span class="o">(</span><span class="n">SUPER</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">Token</span> <span class="n">keyword</span> <span class="o">=</span> <span class="n">previous</span><span class="o">();</span>
      <span class="n">consume</span><span class="o">(</span><span class="n">DOT</span><span class="o">,</span> <span class="s">&quot;Expect &#39;.&#39; after &#39;super&#39;.&quot;</span><span class="o">);</span>
      <span class="n">Token</span> <span class="n">method</span> <span class="o">=</span> <span class="n">consume</span><span class="o">(</span><span class="n">IDENTIFIER</span><span class="o">,</span>
          <span class="s">&quot;Expect superclass method name.&quot;</span><span class="o">);</span>
      <span class="k">return</span> <span class="k">new</span> <span class="n">Expr</span><span class="o">.</span><span class="na">Super</span><span class="o">(</span><span class="n">keyword</span><span class="o">,</span> <span class="n">method</span><span class="o">);</span>
    <span class="o">}</span>
</pre><pre class="insert-after"><br><span></span>    <span class="k">if</span> <span class="o">(</span><span class="n">match</span><span class="o">(</span><span class="n">THIS</span><span class="o">))</span> <span class="k">return</span> <span class="k">new</span> <span class="n">Expr</span><span class="o">.</span><span class="na">This</span><span class="o">(</span><span class="n">previous</span><span class="o">());</span>
</pre></div>

<ul>
<li>add new clause in primary</li>
</ul>
<h3><a href="#semantics" name="semantics"><small>13&#8202;.&#8202;3&#8202;.&#8202;2</small> semantics</a></h3>
<ul>
<li>need to be more precise</li>
<li>whose superclass?</li>
<li>naive answer superclass of &ldquo;this&rdquo;, receiver called</li>
</ul>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="vg">A</span> <span class="p">{</span>
  <span class="n">method</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">print</span> <span class="s">&quot;A method&quot;</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">class</span> <span class="vg">B</span> <span class="o">&lt;</span> <span class="vg">A</span> <span class="p">{</span>
  <span class="n">method</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">print</span> <span class="s">&quot;B method&quot;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">test</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">.</span><span class="n">method</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">class</span> <span class="vg">C</span> <span class="o">&lt;</span> <span class="vg">B</span> <span class="p">{}</span>

<span class="vg">C</span><span class="p">().</span><span class="n">test</span><span class="p">();</span>
</pre></div>


<p><strong>todo: illustrate</strong></p>
<ul>
<li>when call C().test(), this is instance of c</li>
<li>test declared inside B</li>
<li>should start search at B&rsquo;s superclass</li>
<li>
<p>super call search starts at superclass of <em>containing class where super call</em></p>
</li>
<li>
<p>to interp super call at runtime, need access to superclass of surrounding
  class</p>
</li>
<li>could look up by name using same identifier that appears after &ldquo;&lt;&rdquo; in decl</li>
<li>error prone&#8202;&mdash;&#8202;could be shadowed</li>
</ul>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="vg">A</span> <span class="p">{}</span>
<span class="k">class</span> <span class="vg">B</span> <span class="o">&lt;</span> <span class="vg">A</span> <span class="p">{</span>
  <span class="k">var</span> <span class="vg">A</span> <span class="o">=</span> <span class="s">&quot;not the superclass&quot;</span><span class="p">;</span>
  <span class="k">super</span><span class="p">.</span><span class="n">oops</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>


<ul>
<li>also need to be able to find superclass even if declaration out of scope:</li>
</ul>
<div class="codehilite"><pre><span></span><span class="k">fun</span> <span class="n">makeSublass</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">class</span> <span class="vg">A</span> <span class="p">{</span>
    <span class="n">method</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">print</span> <span class="s">&quot;You found me.&quot;</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">class</span> <span class="vg">B</span> <span class="o">&lt;</span> <span class="vg">A</span> <span class="p">{</span>
    <span class="n">method</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">super</span><span class="p">.</span><span class="n">method</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="vg">B</span><span class="p">;</span>
<span class="p">}</span>

<span class="vg">B</span><span class="p">().</span><span class="n">method</span><span class="p">();</span>
</pre></div>


<ul>
<li>look a lot like closure</li>
<li>method body needs to close over reference to superclass so can find it</li>
<li>put &ldquo;super&rdquo; in env like magic variable, similar to &ldquo;this&rdquo;</li>
</ul>
<p><strong>todo: illustrate</strong></p>
<ul>
<li>
<p>since &ldquo;super&rdquo; reserved word, can&rsquo;t be shadowed by var</p>
</li>
<li>
<p>resolver creates scope around class body</p>
</li>
</ul>
<div class="codehilite"><pre class="insert-before"><span></span>      <span class="n">resolve</span><span class="o">(</span><span class="n">stmt</span><span class="o">.</span><span class="na">superclass</span><span class="o">);</span>
</pre><div class="source-file"><em>lox/Resolver.java</em><br>
in <em>visitClassStmt</em>()</div>
<pre class="insert"><span></span>      <span class="n">beginScope</span><span class="o">();</span>
      <span class="n">scopes</span><span class="o">.</span><span class="na">peek</span><span class="o">().</span><span class="na">put</span><span class="o">(</span><span class="s">&quot;super&quot;</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
</pre><pre class="insert-after"><span></span>    <span class="o">}</span>
</pre></div>

<ul>
<li>ends when end of class</li>
</ul>
<div class="codehilite"><pre class="insert-before"><span></span>    <span class="n">endScope</span><span class="o">();</span>
<br></pre><div class="source-file"><em>lox/Resolver.java</em><br>
in <em>visitClassStmt</em>()</div>
<pre class="insert"><span></span>    <span class="k">if</span> <span class="o">(</span><span class="n">stmt</span><span class="o">.</span><span class="na">superclass</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">endScope</span><span class="o">();</span>
<br></pre><pre class="insert-after"><span></span>    <span class="n">currentClass</span> <span class="o">=</span> <span class="n">enclosingClass</span><span class="o">;</span>
</pre></div>

<ul>
<li>
<p>only do this if actually is superclass</p>
</li>
<li>
<p>at runtime need to look up &ldquo;super&rdquo; in env</p>
</li>
<li>need to resolve it, so super expr treat &ldquo;super&rdquo; like var</li>
</ul>
<div class="codehilite"><div class="source-file"><em>lox/Resolver.java</em><br>
add after <em>visitSetExpr</em>()</div>
<pre><span></span>  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">Void</span> <span class="nf">visitSuperExpr</span><span class="o">(</span><span class="n">Expr</span><span class="o">.</span><span class="na">Super</span> <span class="n">expr</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">resolveLocal</span><span class="o">(</span><span class="n">expr</span><span class="o">,</span> <span class="n">expr</span><span class="o">.</span><span class="na">keyword</span><span class="o">);</span>
    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
  <span class="o">}</span>
</pre></div>

<ul>
<li>interp follows suit</li>
</ul>
<div class="codehilite"><pre class="insert-before"><span></span>        <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeError</span><span class="o">(</span><span class="n">stmt</span><span class="o">.</span><span class="na">name</span><span class="o">,</span>
            <span class="s">&quot;Superclass must be a class.&quot;</span><span class="o">);</span>
      <span class="o">}</span>
</pre><div class="source-file"><em>lox/Interpreter.java</em><br>
in <em>visitClassStmt</em>()</div>
<pre class="insert"><span></span>      <span class="n">environment</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Environment</span><span class="o">(</span><span class="n">environment</span><span class="o">);</span>
      <span class="n">environment</span><span class="o">.</span><span class="na">define</span><span class="o">(</span><span class="s">&quot;super&quot;</span><span class="o">,</span> <span class="n">superclass</span><span class="o">);</span>
</pre><pre class="insert-after"><span></span>    <span class="o">}</span>
</pre></div>

<ul>
<li>if superclass, create env for it and store it</li>
</ul>
<div class="codehilite"><pre class="insert-before"><span></span>    <span class="n">LoxClass</span> <span class="n">klass</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LoxClass</span><span class="o">(</span><span class="n">stmt</span><span class="o">.</span><span class="na">name</span><span class="o">.</span><span class="na">lexeme</span><span class="o">,</span>
        <span class="o">(</span><span class="n">LoxClass</span><span class="o">)</span><span class="n">superclass</span><span class="o">,</span> <span class="n">methods</span><span class="o">);</span>
</pre><div class="source-file"><em>lox/Interpreter.java</em><br>
in <em>visitClassStmt</em>()</div>
<pre class="insert"><br><span></span>    <span class="k">if</span> <span class="o">(</span><span class="n">superclass</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">environment</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="na">enclosing</span><span class="o">;</span>
    <span class="o">}</span>
</pre><pre class="insert-after"><br><span></span>    <span class="n">environment</span><span class="o">.</span><span class="na">assign</span><span class="o">(</span><span class="n">stmt</span><span class="o">.</span><span class="na">name</span><span class="o">,</span> <span class="n">klass</span><span class="o">);</span>
</pre></div>

<ul>
<li>discard env after class body</li>
<li>
<p>methods will have this env as their closure</p>
</li>
<li>
<p>ready to handle super expr itself</p>
</li>
</ul>
<div class="codehilite"><div class="source-file"><em>lox/Interpreter.java</em><br>
add after <em>visitSetExpr</em>()</div>
<pre><span></span>  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">Object</span> <span class="nf">visitSuperExpr</span><span class="o">(</span><span class="n">Expr</span><span class="o">.</span><span class="na">Super</span> <span class="n">expr</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">distance</span> <span class="o">=</span> <span class="n">locals</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">expr</span><span class="o">);</span>
    <span class="n">LoxClass</span> <span class="n">superclass</span> <span class="o">=</span> <span class="o">(</span><span class="n">LoxClass</span><span class="o">)</span><span class="n">environment</span><span class="o">.</span><span class="na">getAt</span><span class="o">(</span>
        <span class="n">distance</span><span class="o">,</span> <span class="s">&quot;super&quot;</span><span class="o">);</span>

    <span class="c1">// &quot;this&quot; is always one level nearer than &quot;super&quot;&#39;s environment.</span>
    <span class="n">LoxInstance</span> <span class="n">object</span> <span class="o">=</span> <span class="o">(</span><span class="n">LoxInstance</span><span class="o">)</span><span class="n">environment</span><span class="o">.</span><span class="na">getAt</span><span class="o">(</span>
        <span class="n">distance</span> <span class="o">-</span> <span class="mi">1</span><span class="o">,</span> <span class="s">&quot;this&quot;</span><span class="o">);</span>

    <span class="n">LoxFunction</span> <span class="n">method</span> <span class="o">=</span> <span class="n">superclass</span><span class="o">.</span><span class="na">findMethod</span><span class="o">(</span>
        <span class="n">object</span><span class="o">,</span> <span class="n">expr</span><span class="o">.</span><span class="na">method</span><span class="o">.</span><span class="na">lexeme</span><span class="o">);</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">method</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeError</span><span class="o">(</span><span class="n">expr</span><span class="o">.</span><span class="na">method</span><span class="o">,</span>
          <span class="s">&quot;Undefined property &#39;&quot;</span> <span class="o">+</span> <span class="n">expr</span><span class="o">.</span><span class="na">method</span><span class="o">.</span><span class="na">lexeme</span> <span class="o">+</span> <span class="s">&quot;&#39;.&quot;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="n">method</span><span class="o">;</span>
  <span class="o">}</span>
</pre></div>

<ul>
<li>little complex</li>
<li>two exprs in one - left and right of dot</li>
<li>
<p>first, look up superclass by finding &ldquo;super&rdquo; var</p>
</li>
<li>
<p>then handle property access</p>
</li>
<li>don&rsquo;t need to handle fields, not inherited</li>
<li>
<p>look up method and bind to this</p>
</li>
<li>
<p>need to find &ldquo;this&rdquo;</p>
</li>
<li>need to bind receiver</li>
<li>locals map is keyed off tokens, don&rsquo;t have &ldquo;this&rdquo; token</li>
<li>instead, note that env where this is bound is always just inside one where
  &ldquo;super&rdquo; is</li>
<li>
<p>kinda hacky, clox better</p>
</li>
<li>
<p>then find method</p>
</li>
<li>returns method with this bound to obj</li>
<li>
<p>can fail if not found</p>
</li>
<li>
<p>try boston cream example</p>
</li>
</ul>
<h3><a href="#invalid-uses-of-super" name="invalid-uses-of-super"><small>13&#8202;.&#8202;3&#8202;.&#8202;3</small> invalid uses of super</a></h3>
<ul>
<li>what can go wrong?</li>
</ul>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="vg">Eclair</span> <span class="p">{</span>
  <span class="n">cook</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">.</span><span class="n">cook</span><span class="p">();</span>
    <span class="k">print</span> <span class="s">&quot;Pipe full of crème pâtissière.&quot;</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<ul>
<li>no superclass</li>
<li>at runtime, no env with &ldquo;super&rdquo;</li>
<li>code for interp super assumes superclass is found</li>
<li>
<p>crashes interp</p>
</li>
<li>
<p>could check for no super at runtime</p>
</li>
<li>but know statically that Eclair no super, no super clause</li>
<li>simpler example:</li>
</ul>
<div class="codehilite"><pre><span></span><span class="k">super</span><span class="p">.</span><span class="n">notEvenInAClass</span><span class="p">();</span>
</pre></div>


<ul>
<li>like this and return, can statically tell where allowed to use</li>
<li>report static error</li>
<li>add new &ldquo;type&rdquo; of class</li>
</ul>
<div class="codehilite"><pre class="insert-before"><span></span>    <span class="n">NONE</span><span class="o">,</span>
</pre><div class="source-file"><em>lox/Resolver.java</em><br>
in class <em>Resolver</em><br>
replace 1 line</div>
<pre class="insert"><span></span>    <span class="n">CLASS</span><span class="o">,</span>
    <span class="n">SUBCLASS</span>
</pre><pre class="insert-after"><span></span>  <span class="o">}</span>
</pre></div>

<ul>
<li>
<p>use that to track whether surrounding class has superclass or not</p>
</li>
<li>
<p>when resolving class decl, if class has super, use new type instead of CLASS</p>
</li>
</ul>
<div class="codehilite"><pre class="insert-before"><span></span>    <span class="k">if</span> <span class="o">(</span><span class="n">stmt</span><span class="o">.</span><span class="na">superclass</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</pre><div class="source-file"><em>lox/Resolver.java</em><br>
in <em>visitClassStmt</em>()</div>
<pre class="insert"><span></span>      <span class="n">currentClass</span> <span class="o">=</span> <span class="n">ClassType</span><span class="o">.</span><span class="na">SUBCLASS</span><span class="o">;</span>
</pre><pre class="insert-after"><span></span>      <span class="n">resolve</span><span class="o">(</span><span class="n">stmt</span><span class="o">.</span><span class="na">superclass</span><span class="o">);</span>
</pre></div>

<ul>
<li>then when resolve super, check type</li>
</ul>
<div class="codehilite"><pre class="insert-before"><span></span>  <span class="kd">public</span> <span class="n">Void</span> <span class="nf">visitSuperExpr</span><span class="o">(</span><span class="n">Expr</span><span class="o">.</span><span class="na">Super</span> <span class="n">expr</span><span class="o">)</span> <span class="o">{</span>
</pre><div class="source-file"><em>lox/Resolver.java</em><br>
in <em>visitSuperExpr</em>()</div>
<pre class="insert"><span></span>    <span class="k">if</span> <span class="o">(</span><span class="n">currentClass</span> <span class="o">==</span> <span class="n">ClassType</span><span class="o">.</span><span class="na">NONE</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">Lox</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">expr</span><span class="o">.</span><span class="na">keyword</span><span class="o">,</span>
          <span class="s">&quot;Cannot use &#39;super&#39; outside of a class.&quot;</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">currentClass</span> <span class="o">!=</span> <span class="n">ClassType</span><span class="o">.</span><span class="na">SUBCLASS</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">Lox</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">expr</span><span class="o">.</span><span class="na">keyword</span><span class="o">,</span>
          <span class="s">&quot;Cannot use &#39;super&#39; in a class with no superclass.&quot;</span><span class="o">);</span>
    <span class="o">}</span>
<br></pre><pre class="insert-after"><span></span>    <span class="n">resolveLocal</span><span class="o">(</span><span class="n">expr</span><span class="o">,</span> <span class="n">expr</span><span class="o">.</span><span class="na">keyword</span><span class="o">);</span>
</pre></div>

<h2><a href="#conclusion" name="conclusion"><small>13&#8202;.&#8202;4</small> Conclusion</a></h2>
<ul>
<li>feel like should say something</li>
<li>reached end of part ii, and first interpreter</li>
<li>real accomplishment</li>
<li>
<p>xxx lines of code, impl:</p>
<ul>
<li>lexer</li>
<li>ast</li>
<li>parser</li>
<li>static resolution pass</li>
<li>interpreter</li>
<li>bools, numbers, strings</li>
<li>prefix, infix, expressions</li>
<li>control flow</li>
<li>variables</li>
<li>block scope</li>
<li>functions</li>
<li>classes with ctors, fields, methods</li>
<li>inheritance super calls</li>
</ul>
</li>
<li>
<p>did it all ourselves, no dependencies except java stdlib</p>
</li>
<li>few people know how to impl langs</li>
<li>
<p>real accomplishment</p>
</li>
<li>
<p>not done yet</p>
</li>
<li>no deps like parser library, but still dep on jvm</li>
<li>get mem mgmt and object representation for free</li>
<li>also, interp not fast</li>
<li>next part, fill in those gaps</li>
</ul>
<div class="challenges">
<h2><a href="#challenges" name="challenges">Challenges</a></h2>

<ol>
<li>
<p><strong>todo</strong></p>
</li>
<li>
<p>In Lox, as in most other object-oriented languages when looking up a method,
    we start at the bottom of the class hierarchy and work our way up&#8202;&mdash;&#8202;a
    subclass&rsquo;s method is preferred over a superclass method of the same name.
    This means subclasses override superclass methods. In order to get to the
    superclass method from within an overriding method, you use <code>super</code>.</p>
<p>The language BETA takes an opposite approach. When you call a method, it
starts at the top of the class hierarchy and works down. A superclass method
wins over a subclass method. In order to get to the subclass method, the
superclass method can call <code>inner</code>, which is sort of like the inverse of
<code>super</code>. It chains to the next method down the hierarchy. If the superclass
method doesn&rsquo;t call <code>inner</code>, then the subclass has no way of overriding or
modifying the superclass&rsquo;s behavior.</p>
<p>Take out Lox&rsquo;s current overriding and <code>super</code> behavior and replace it with
BETA&rsquo;s semantics. In short:</p>
<ul>
<li>
<p>When calling a method on a class, prefer the method <em>highest</em> on the
  class&rsquo;s inheritance chain.</p>
</li>
<li>
<p>Inside the body of a method, a call to <code>inner</code> looks for a method with the
  same name in the nearest subclass along the inheritance chain between the
  class containing the <code>inner</code> and the class of <code>this</code>. If there is no
  matching method, the <code>inner</code> call does nothing.</p>
</li>
</ul>
<p>For example:</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="vg">Doughnut</span> <span class="p">{</span>
  <span class="n">cook</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">print</span> <span class="s">&quot;Fry until golden brown.&quot;</span><span class="p">;</span>
    <span class="n">inner</span><span class="p">();</span>
    <span class="k">print</span> <span class="s">&quot;Place in a nice box.&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">class</span> <span class="vg">BostonCream</span> <span class="o">&lt;</span> <span class="vg">Doughnut</span> <span class="p">{</span>
  <span class="n">cook</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">print</span> <span class="s">&quot;Pipe full of custard and coat with chocolate.&quot;</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="vg">BostonCream</span><span class="p">().</span><span class="n">cook</span><span class="p">();</span>
</pre></div>


<p>This should print:</p>
<div class="codehilite"><pre><span></span>Fry until golden brown.
Pipe full of custard and coat with chocolate.
Place in a nice box.
</pre></div>


<p>Note how <code>inner()</code> lets the subclass refine the superclass&rsquo;s method while
giving the superclass control over <em>when</em> the refinement happens.</p>
</li>
</ol>
<p>1.</p>
</div>
<p><strong>todo: note on multiple inheritance, mixins, traits?</strong></p>

<footer>
<a href="a-bytecode-virtual-machine.html" class="next">
  Next Part: &ldquo;A Bytecode Virtual Machine&rdquo; &rarr;
</a>
Hand-crafted by Robert Nystrom&ensp;&mdash;&ensp;<a href="https://github.com/munificent/craftinginterpreters/blob/master/LICENSE" target="_blank">&copy; 2015&hairsp;&ndash;&hairsp;2017</a>
</footer>
</article>

</div>
</body>
</html>